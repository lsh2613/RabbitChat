<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Rooms</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
<div class="container">

    <!-- 헤더 -->
    <div id="header-placeholder"></div>

    <!-- 전체 채팅방 목록 -->
    <div class="api-block">
        <h4>전체 채팅방 목록</h4>
        <ul class="list-group" id="chatRoomList"></ul>
    </div>

</div>

<script src="../js/header.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const token = sessionStorage.getItem("accessToken");

        if (!token) {
            alert("Access Token이 없습니다. 먼저 로그인해주세요.");
            window.location.href = "/index.html";
            return;
        }

        fetch("/chat-rooms", {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Accept": "application/json"
            }
        })
        .then(response => {
            if (!response.ok) throw new Error("채팅방 목록 조회에 실패했습니다.");
            return response.json();
        })
        .then(chatRooms => {
            const list = document.getElementById("chatRoomList");

            if (chatRooms.length === 0) {
                const emptyMsg = document.createElement("li");
                emptyMsg.className = "list-group-item";
                emptyMsg.textContent = "채팅방이 없습니다.";
                list.appendChild(emptyMsg);
                return;
            }

            chatRooms.forEach(room => {
                const li = document.createElement("li");
                li.className = "list-group-item";
                li.innerHTML = `
                    <div>
                        <strong>Chat Room ID:</strong> ${room.chatRoomId}<br>
                        <strong>Participants:</strong>
                        <ul id="members-${room.chatRoomId}" class="mt-1"></ul>
                    </div>
                `;
                list.appendChild(li);

                // 채팅방 참가자 조회
                fetch(`/chat-rooms/${room.chatRoomId}/members`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                })
                .then(res => {
                    if (!res.ok) throw new Error("참여자 조회 실패");
                    return res.json();
                })
                .then(members => {
                    const memberList = document.getElementById(`members-${room.chatRoomId}`);
                    if (members.length === 0) {
                        const noMember = document.createElement("li");
                        noMember.className = "list-group-item";
                        noMember.textContent = "참여자가 없습니다.";
                        memberList.appendChild(noMember);
                    } else {
                        members.forEach(member => {
                            const mli = document.createElement("li");
                            mli.className = "list-group-item";
                            mli.textContent = `Member ID: ${member.memberId}, Username: ${member.username}`;
                            memberList.appendChild(mli);
                        });
                    }
                })
                .catch(error => {
                    const memberList = document.getElementById(`members-${room.chatRoomId}`);
                    const errorItem = document.createElement("li");
                    errorItem.className = "list-group-item text-danger";
                    errorItem.textContent = "참여자 목록을 불러오지 못했습니다.";
                    memberList.appendChild(errorItem);
                    console.error("Error fetching members:", error);
                });
            });
        })
        .catch(error => {
            alert(error.message);
            console.error("Error fetching chat rooms:", error);
        });
    });
</script>
</body>
</html>