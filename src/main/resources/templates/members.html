<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Members List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
<div class="container">

    <!-- 헤더 -->
    <div id="header-placeholder"></div>

    <br>

    <!-- 전체 회원 조회 -->
    <div class="api-section" th:if="${members != null}">
        <div class="api-block">
            <h4>모든 회원 조회</h4>

            <ul class="list-group">
                <li class="list-group-item" th:each="member : ${members}">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
                        <div>
                            <strong>ID:</strong> <span th:text="${member.id}"></span><br>
                            <strong>Username:</strong> <span th:text="${member.username}"
                                                             th:attr="id=${'username-' + member.id}"></span><br>

                            <!-- Access Token + 발급 버튼 + 로그인 버튼 -->
                            <div class="d-flex align-items-center gap-2 mt-2">
                                <strong>Access Token:</strong>
                                <span th:attr="id=${'accessToken-' + member.id}"></span>

                                <!-- 토큰 발급 버튼 -->
                                <button class="btn btn-sm btn-outline-success"
                                        th:attr="id=${'token-button-' + member.id}"
                                        th:onclick="|issueToken(${member.id})|">
                                    토큰 발급
                                </button>

                                <!-- 로그인 버튼 (초기에는 숨김) -->
                                <button class="btn btn-sm btn-outline-primary"
                                        th:attr="id=${'login-button-' + member.id}"
                                        onclick="login(this.getAttribute('data-member-id'))"
                                        th:attrappend="data-member-id=${member.id}"
                                        style="display: none;">
                                    로그인
                                </button>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>

        </div>
    </div>

</div>

<script src="js/header.js"></script>

<script>
    function issueToken(memberId) {
        const tokenButton = document.getElementById(`token-button-${memberId}`);
        const tokenText = document.getElementById(`accessToken-${memberId}`);
        const loginButton = document.getElementById(`login-button-${memberId}`);

        tokenButton.style.display = 'none'; // 버튼 숨기기

        fetch("http://localhost:8080/members/tokens?memberId=" + memberId)
            .then(response => response.text())
            .then(token => {
                tokenText.innerText = token; // 토큰 표시
                loginButton.style.display = 'inline-block'; // 로그인 버튼 보이기
            })
            .catch(error => alert('토큰 발급에 실패했습니다: ' + error));
    }

    function login(memberId) {
        sessionStorage.clear();
        const username = document.getElementById(`username-${memberId}`).innerText;
        const accessToken = document.getElementById(`accessToken-${memberId}`).innerText;

        sessionStorage.setItem('memberId', memberId);
        sessionStorage.setItem('username', username);
        sessionStorage.setItem('accessToken', accessToken);

        alert(`${username} 님으로 로그인되었습니다!`);
    }
</script>

</body>

</html>