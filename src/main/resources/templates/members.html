<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Members List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
<div class="container">

    <!-- 헤더 -->
    <div id="header-placeholder"></div>

    <br>

    <!-- 전체 회원 조회 -->
    <div class="api-section" th:if="${members != null}">
        <div class="api-block">
            <h4>모든 회원 조회</h4>

            <ul class="list-group">
                <li class="list-group-item" th:each="member : ${members}">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
                        <div>
                            <strong>ID:</strong> <span th:text="${member.id}"></span><br>
                            <strong>Username:</strong> <span th:text="${member.username}"></span><br>

                            <!-- 토큰 발급 버튼 -->
                            <button class="btn btn-sm btn-outline-success"
                                    th:attr="id=${'token-button-' + member.id}"
                                    th:onclick="|issueToken(${member.id})|">
                                토큰 발급
                            </button>

                            <!-- 발급된 토큰 영역을 Username 아래로 이동 -->
                            <div class="token-container d-none"
                                 th:attr="id=${'token-container-' + member.id}">
                                <strong>Access Token:</strong>
                                <span class="token-text" th:attr="id=${'accessToken-' + member.id}"></span><br>
                                <button class="btn btn-sm btn-outline-primary"
                                        th:onclick="|copyToken(${member.id})|">
                                    Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>

        </div>
    </div>

</div>

<script src="js/header.js"></script>

<script>
    function issueToken(memberId) {
        // 토큰 발급 버튼 숨기기
        const tokenButton = document.getElementById(`token-button-${memberId}`);
        tokenButton.style.display = 'none'; // 버튼 숨기기

        fetch("http://localhost:8080/members/tokens?memberId=" + memberId)
            .then(response => response.text())
            .then(token => {
                const tokenContainer = document.getElementById(`token-container-${memberId}`);
                const tokenText = document.getElementById(`accessToken-${memberId}`);
                tokenText.innerText = token;
                tokenContainer.classList.remove('d-none'); // 토큰 컨테이너 표시
            })
            .catch(error => alert('토큰 발급에 실패했습니다: ' + error));
    }

    function copyToken(memberId) {
        const tokenText = document.getElementById(`accessToken-${memberId}`).innerText;
        navigator.clipboard.writeText(tokenText).then(() => {
            alert('Access Token이 복사되었습니다!');
        }).catch(err => {
            alert('복사에 실패했습니다: ' + err);
        });
    }
</script>

</body>

</html>